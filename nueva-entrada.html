<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>ComentaTuVida</title>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/style.css"/>
	<link rel="stylesheet" type="text/css" href="css/nueva-entrada.css">
	<script src="js/functions.js"> </script>
</head>
<body>
	<header>
		<input type="checkbox" id="menu-toogle"/>
		<label for="menu-toogle"></label>
		<nav>
			<ul>
				<li><input type="text" name="buscar" value="" placeholder="Busqueda" id="search-bar"/></li>
				<li>
					<ul>
						<li class="item loggedout"><a href="login.html"><i class="material-icons">person</i>Login</a></li>
						<li class="item loggedout"><a href="registro.html"><i class="material-icons">person_add</i>Registro</a></li>
						<li class="item loggedin"><a href="#!" onclick="logout();"><i class="material-icons">cancel</i>LogOut</a></li>
						<li class="item loggedin"><a href="nueva-entrada.html"><i class="material-icons">add_circle</i>Nuevo</a></li>
						<li class="info">
							<a href="index.html"><h2>ComentaTuVida</h2></a>
							<p>La web de comentarios lider.</p>
						</li>
					</ul>
				</li>
				<li class="cat active"><a href="index.html">Inicio</a></li>
				<li class="cat"><a href="buscar.html">Buscar</a></li>
				<li class="cat"><a href="pagina5.html">Eventos</a></li>
				<li class="cat"><a href="pagina5.html">Retos</a></li>
			</ul>
		</nav>
		<div class="logo">
			<a href="index.html"><img src="img/logo.png" alt="Logo"></a>
		</div>
		<div class="headerinfo">
			<a href="index.html"><h1>ComentaTuVida</h1></a>
			<p>La web de comentarios lider.</p>
		</div>
		<div class="headerlinks">
			<a class="loggedout" href="login.html"><i class="material-icons">person</i>Login</a>
			<a class="loggedout" href="registro.html"><i class="material-icons">person_add</i>Registro</a>
			<a class="loggedin" href="#!" onclick="logout();"><i class="material-icons">cancel</i>LogOut</a>
			<a class="loggedin" href="nueva-entrada.html"><i class="material-icons">add_circle</i>Nuevo</a>
		</div>
	</header>
	<main>
		<section>
			<div id="overlay">
				<a id="volver" href="index.html"> Volver al inicio </a>
			</div>
			<form onsubmit="sendForm(event, this);">
				<h2>Nueva entrada</h2>
				<!--<form>-->
				<label for="nombre">Titulo</label>
				<input type="text" name="nombre" id="nombre" maxlength="200" required autofocus placeholder="Titulo"/>
				<label for="descripcion">Descripción</label>
				<textarea name="descripcion" id="descripcion" required placeholder="Texto"></textarea>
				<p id="aviso">
					Advertencia la foto no debe pesar mas de 500Kb
				</p>
				<p id="Fotos">
				</p>
				<p id="boton" onclick="anadirFoto();">Añadir Foto</p>
				<input type="submit" value="Enviar entrada"/>
					<div>
						<template id="template-foto">
							<div class="tempFoto">
								<h4>Foto</h4>
								<input type="file" name="file" class="file" accept="image/x-png,image/gif,image/jpeg" required>
								<output class="list" onclick="clickFoto(this);"></output>
								<input type="hidden" name="valido" class="validacion" value="false"/>
								<p><textarea  cols="30" rows="5" required></textarea></p>
								<p><button onclick="borrarFoto(this);">Borrar Foto</button></p>
							</div>
						</template>
					</div>
					<script>
					function clickFoto(evt){
						evt.parentNode.querySelector('.file').click();
					}
						function anadirFoto(){
							var temp = document.getElementById("template-foto");
							var Foto = document.getElementById("Fotos");
							Foto.appendChild(temp.content.cloneNode(true));
							Foto.querySelector('.file').addEventListener('change', handleFileSelect, false);
						}
						
						function borrarFoto(exp){
							let div = exp.parentNode.parentNode;
							div.remove();
						}
						function handleFileSelect(evt) {
							var valido=true;
							var x;
		   					var files = evt.target.files; // FileList object
		    					// Loop through the FileList and render image files as thumbnails.
		    				for (var i = 0, f; f = files[i]; i++) {
	      						if (!f.type.match('image.*')) {
	      							continue;
	      						}
	      						if(files[i].size/1024<500){
	      							//evt.target.parentNode.querySelector('.file').value= "";
	      							//alert("El archivo es demasiado grande, debe pesar menos de 500KB");
	      							//x = evt.target.parentNode.querySelector('img');
	      							//x.parentNode.removeChild(x);
	      							revelar(evt.target);
	      							document.getElementById("aviso").innerHTML="Advertencia la foto no debe pesar mas de 500Kb";
	      							evt.target.parentNode.querySelector(".validacion").value="true";
		      					}
		      					else{
		      						document.getElementById("aviso").innerHTML="AVISO LA IMAGEN PESA MAS DE 500KB";
		      						ocultar(evt.target);
		      						evt.target.parentNode.querySelector(".validacion").value="false";
		      					}	
	      						var reader = new FileReader();
	      							// Closure to capture the file information.
	      							reader.onload = (function(theFile) {
	      								return function(e) {
	          							// Render thumbnail.
	          							evt.target.parentNode.querySelector('.list').innerHTML= ['<img class="thumb" src="', e.target.result,
	          							'" title="', escape(theFile.name), '"/>'].join('');

	          						};
	          					})(f);
	      						// Read in the image file as a data URL.
	      						reader.readAsDataURL(f);
		      				}
		      			}
		      			function openNav(){
		      				document.getElementById('overlay').style.width = "100%";
		      			}
		      			function sendForm(event, form){

		      				event.preventDefault();
		      				var obj = JSON.parse(sessionStorage.getItem("login"));
		      				var clave = obj.clave;
		      				var nombre = document.getElementById("nombre").value;
		      				var descripcion = document.getElementById("descripcion").value;
		      				var login = obj.login;
		      				ajaxPostRequest("nombre="+nombre+"&descripcion="+descripcion+"&login="+login, 'rest/entrada/', function(response){
		      					if(response.RESULTADO=='ok'){
		      						var fotos = document.querySelectorAll(".tempFoto");
		      						for(let foto of fotos){
		      							let img = foto.querySelector("input.file");
		      							let text = foto.querySelector("textarea");
		      							ajaxPostRequest("login="+login+"&id_entrada="+response.id+"&texto="+text+"&foto="+img.files[0],"rest/foto/",function(response){
		      							},clave);

		      						}
		      						//openNav();
		      					}
		      					else{
		      						console.log(response);	
		      					}
		      				},clave);

		      			}
		      			function ocultar(ejm){
		      				document.querySelector('#aviso').style.backgroundColor="red";
		      			}
		      			function revelar(ejm){
		      				document.querySelector('#aviso').style.backgroundColor="transparent";
		      			}

	  				</script>
  				</form>
  			</section>
  		</main>
  		<footer>
  			<div>
  				<h2>Información de contacto</h2>
  				<p>
  					<b>Nombre</b>: ComentaTuVida<br>
  					<b>Telefono</b>: 695847362<br>
  					<b>E-mail</b>: comentatuvida@comentala.com<br>
  					<b>Dirección</b>: Calle falsa, 123, Madrid, España
  				</p>
  			</div>
  			<div>
  				<h2>Enlaces útiles</h2>
  				<p>
  					<a href="acerca.html">Acerca de ComentaTuVida</a>
  					<a href="legal.html">Informacion legal</a>
  					<a href="privacidad.html">Politica de privacidad</a>
  					<a href="cookies.html">Politica de cookies</a>
  				</p>
  			</div>
  			<p><b>&copy;2017 - ComentaTuVida</b></p>
  		</footer>
  		<script>
			isLoggedIn();
			if (!isJson(sessionStorage.getItem("login")) || JSON.parse(sessionStorage.getItem("login")).RESULTADO != "ok"){
				location.href="index.html";
			}
		</script>
  	</body>
  </html>